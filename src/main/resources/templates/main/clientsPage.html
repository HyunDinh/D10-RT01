<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Danh sách tài khoản</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding: 20px;
        }
        .table-container {
            max-width: 1200px;
            margin: auto;
        }
        .error-message {
            color: red;
            display: none;
            margin-top: 10px;
        }
        .success-message {
            color: green;
            display: none;
            margin-top: 10px;
        }
    </style>
</head>
<body>
<div class="table-container">
    <h1 class="text-center mb-4">Danh sách tài khoản</h1>

    <!-- Form thêm tài khoản mới -->
    <form id="addClientForm" class="mb-4">
        <div class="row g-3">
            <div class="col-md-3">
                <input type="text" class="form-control" id="username" name="username" placeholder="Tên người dùng" required>
            </div>
            <div class="col-md-3">
                <input type="password" class="form-control" id="passwordHash" name="passwordHash" placeholder="Mật khẩu" required>
            </div>
            <div class="col-md-3">
                <input type="email" class="form-control" id="email" name="email" placeholder="Email" required>
            </div>
            <div class="col-md-2">
                <input type="text" class="form-control" id="phoneNumber" name="phoneNumber" placeholder="Số điện thoại" required>
            </div>
            <div class="col-md-2">
                <select class="form-select" id="role" name="role" required>
                    <option value="" disabled selected>Chọn vai trò</option>
                    <option value="child">CHILD</option>
                    <option value="parent">PARENT</option>
                    <option value="teacher">TEACHER</option>
                    <option value="admin">ADMIN</option>
                </select>
            </div>
            <div class="col-md-1">
                <button type="submit" class="btn btn-primary w-100">Thêm</button>
            </div>
        </div>
        <div id="errorMessage" class="error-message"></div>
        <div id="successMessage" class="success-message"></div>
    </form>

    <!-- Bảng danh sách tài khoản -->
    <table class="table table-striped table-bordered" id="clientTable">
        <thead class="table-dark">
        <tr>
            <th>ID</th>
            <th>Tên người dùng</th>
            <th>Email</th>
            <th>Số điện thoại</th>
            <th>Vai trò</th>
            <th>Hành động</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="client : ${clients}">
            <td th:text="${client.id}"></td>
            <td th:text="${client.username}"></td>
            <td th:text="${client.email}"></td>
            <td th:text="${client.phoneNumber}"></td>
            <td th:text="${client.role}"></td>
            <td>
                <button class="btn btn-danger btn-sm delete-btn" th:attr="data-id=${client.id}">Xóa</button>
            </td>
        </tr>
        <tr th:if="${clients == null or clients.isEmpty()}">
            <td colspan="6" class="text-center">Không tìm thấy tài khoản</td>
        </tr>
        </tbody>
    </table>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<!-- JavaScript tùy chỉnh -->
<script>
    document.getElementById('addClientForm').addEventListener('submit', async function (e) {
        e.preventDefault();

        const username = document.getElementById('username').value;
        const passwordHash = document.getElementById('passwordHash').value;
        const email = document.getElementById('email').value;
        const phoneNumber = document.getElementById('phoneNumber').value;
        const role = document.getElementById('role').value;
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');

        // Xóa thông báo cũ
        errorMessage.style.display = 'none';
        successMessage.style.display = 'none';

        try {
            const response = await fetch('/api/clients', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ username, passwordHash, email, phoneNumber, role }),
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Không thể thêm tài khoản');
            }

            const newClient = await response.json();

            // Thêm dòng mới vào bảng
            const tableBody = document.querySelector('#clientTable tbody');
            const noClientsRow = document.querySelector('#clientTable tbody tr td[colspan="6"]');
            if (noClientsRow) {
                noClientsRow.parentElement.remove();
            }

            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td>${newClient.id}</td>
                <td>${newClient.username}</td>
                <td>${newClient.email}</td>
                <td>${newClient.phoneNumber}</td>
                <td>${newClient.role}</td>
                <td><button class="btn btn-danger btn-sm delete-btn" data-id="${newClient.id}">Xóa</button></td>
            `;
            tableBody.appendChild(newRow);

            // Xóa form
            document.getElementById('addClientForm').reset();
            successMessage.textContent = 'Thêm tài khoản thành công!';
            successMessage.style.display = 'block';
        } catch (error) {
            errorMessage.textContent = error.message;
            errorMessage.style.display = 'block';
        }
    });

    // Xử lý nút xóa
    document.addEventListener('click', async function (e) {
        if (e.target.classList.contains('delete-btn')) {
            const clientId = e.target.getAttribute('data-id');
            const errorMessage = document.getElementById('errorMessage');
            const successMessage = document.getElementById('successMessage');

            // Xóa thông báo cũ
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';

            try {
                const response = await fetch(`/api/clients/${clientId}`, {
                    method: 'DELETE',
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Không thể xóa tài khoản');
                }

                // Xóa dòng khỏi bảng
                e.target.closest('tr').remove();

                // Kiểm tra nếu bảng trống
                const tableBody = document.querySelector('#clientTable tbody');
                if (tableBody.children.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="6" class="text-center">Không tìm thấy tài khoản</td></tr>';
                }

                successMessage.textContent = 'Xóa tài khoản thành công!';
                successMessage.style.display = 'block';
            } catch (error) {
                errorMessage.textContent = error.message;
                errorMessage.style.display = 'block';
            }
        }
    });
</script>
</body>
</html>